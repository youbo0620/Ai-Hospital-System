import google.generativeai as genai
import os
import time
import pandas as pd
from dotenv import load_dotenv

load_dotenv()
GOOGLE_API_KEY = os.getenv("GOOGLE_API_KEY")

if not GOOGLE_API_KEY:
    raise ValueError("âŒ æ‰¾ä¸åˆ° GOOGLE_API_KEYï¼Œè«‹æª¢æŸ¥ .env æª”æ¡ˆè¨­å®šï¼")

genai.configure(api_key=GOOGLE_API_KEY)
model = genai.GenerativeModel('gemini-2.5-flash-lite')

# === ğŸ‡¹ğŸ‡­ å®Œæ•´æ³°æ–‡æ¸¬è©¦é›† (50 Cases) ===
test_cases = [
    # --- à¸­à¸²à¸¢à¸¸à¸£à¸à¸£à¸£à¸¡ (Internal Medicine) ---
    {"symptom": "à¸›à¸§à¸”à¸—à¹‰à¸­à¸‡à¸£à¸¸à¸™à¹à¸£à¸‡à¹à¸¥à¸°à¸—à¹‰à¸­à¸‡à¹€à¸ªà¸µà¸¢à¹„à¸¡à¹ˆà¸«à¸¢à¸¸à¸”", "expected": "à¸­à¸²à¸¢à¸¸à¸£à¸à¸£à¸£à¸¡"}, # è…¹ç—›è…¹ç€‰
    {"symptom": "à¹à¸™à¹ˆà¸™à¸«à¸™à¹‰à¸²à¸­à¸ à¸«à¸²à¸¢à¹ƒà¸ˆà¹„à¸¡à¹ˆà¸ªà¸°à¸”à¸§à¸", "expected": "à¸­à¸²à¸¢à¸¸à¸£à¸à¸£à¸£à¸¡"}, # èƒ¸æ‚¶
    {"symptom": "à¹€à¸§à¸µà¸¢à¸™à¸«à¸±à¸§ à¸„à¸¥à¸·à¹ˆà¸™à¹„à¸ªà¹‰ à¹à¸¥à¸°à¸¡à¸µà¹„à¸‚à¹‰", "expected": "à¸­à¸²à¸¢à¸¸à¸£à¸à¸£à¸£à¸¡"}, # é ­æšˆç™¼ç‡’
    {"symptom": "à¸›à¸±à¸ªà¸ªà¸²à¸§à¸°à¸šà¹ˆà¸­à¸¢à¹à¸¥à¸°à¹à¸ªà¸šà¸‚à¸±à¸”", "expected": "à¸­à¸²à¸¢à¸¸à¸£à¸à¸£à¸£à¸¡"}, # é »å°¿ç¼ç†±
    {"symptom": "à¸à¸£à¸”à¹„à¸«à¸¥à¸¢à¹‰à¸­à¸™ à¹à¸ªà¸šà¸£à¹‰à¸­à¸™à¸à¸¥à¸²à¸‡à¸­à¸", "expected": "à¸­à¸²à¸¢à¸¸à¸£à¸à¸£à¸£à¸¡"}, # èƒƒé£Ÿé“é€†æµ
    {"symptom": "à¸„à¸§à¸²à¸¡à¸”à¸±à¸™à¸‚à¸¶à¹‰à¸™à¸ªà¸¹à¸‡ à¸›à¸§à¸”à¸•à¸¶à¸‡à¸—à¹‰à¸²à¸¢à¸—à¸­à¸¢", "expected": "à¸­à¸²à¸¢à¸¸à¸£à¸à¸£à¸£à¸¡"}, # é«˜è¡€å£“
    {"symptom": "à¸«à¸´à¸§à¸™à¹‰à¸³à¸šà¹ˆà¸­à¸¢ à¸”à¸·à¹ˆà¸¡à¸™à¹‰à¸³à¹€à¸¢à¸­à¸°à¹à¸•à¹ˆà¸™à¹‰à¸³à¸«à¸™à¸±à¸à¸¥à¸”", "expected": "à¸­à¸²à¸¢à¸¸à¸£à¸à¸£à¸£à¸¡"}, # ç³–å°¿ç—…
    {"symptom": "à¹ƒà¸ˆà¸ªà¸±à¹ˆà¸™ à¸«à¸±à¸§à¹ƒà¸ˆà¹€à¸•à¹‰à¸™à¹€à¸£à¹‡à¸§à¸œà¸´à¸”à¸›à¸à¸•à¸´", "expected": "à¸­à¸²à¸¢à¸¸à¸£à¸à¸£à¸£à¸¡"}, # å¿ƒæ‚¸
    {"symptom": "à¸«à¸™à¹‰à¸²à¸‹à¸µà¸” à¸¥à¸¸à¸à¹à¸¥à¹‰à¸§à¸«à¸™à¹‰à¸²à¸¡à¸·à¸” (à¹‚à¸¥à¸«à¸´à¸•à¸ˆà¸²à¸‡)", "expected": "à¸­à¸²à¸¢à¸¸à¸£à¸à¸£à¸£à¸¡"}, # è²§è¡€
    {"symptom": "à¸™à¸­à¸™à¹„à¸¡à¹ˆà¸«à¸¥à¸±à¸šà¸¡à¸²à¸«à¸¥à¸²à¸¢à¸§à¸±à¸™ à¸­à¹ˆà¸­à¸™à¹€à¸à¸¥à¸µà¸¢à¸¡à¸²à¸", "expected": "à¸­à¸²à¸¢à¸¸à¸£à¸à¸£à¸£à¸¡"}, # å¤±çœ 

    # --- à¸¨à¸±à¸¥à¸¢à¸à¸£à¸£à¸¡ (Surgery) ---
    {"symptom": "à¸¡à¸µà¸”à¸šà¸²à¸”à¸¡à¸·à¸­à¸¥à¸¶à¸ à¹€à¸¥à¸·à¸­à¸”à¹„à¸«à¸¥à¹„à¸¡à¹ˆà¸«à¸¢à¸¸à¸”", "expected": "à¸¨à¸±à¸¥à¸¢à¸à¸£à¸£à¸¡"}, # åˆ‡åˆ°æ‰‹
    {"symptom": "à¸«à¸à¸¥à¹‰à¸¡à¸à¸£à¸°à¹à¸—à¸à¹€à¸‚à¹ˆà¸² à¸šà¸§à¸¡à¹€à¸›à¹ˆà¸‡ à¹€à¸”à¸´à¸™à¹„à¸¡à¹ˆà¹„à¸”à¹‰", "expected": "à¸¨à¸±à¸¥à¸¢à¸à¸£à¸£à¸¡"}, # è·Œå€’
    {"symptom": "à¹‚à¸”à¸™à¸™à¹‰à¸³à¸£à¹‰à¸­à¸™à¸¥à¸§à¸ à¸œà¸´à¸§à¹à¸”à¸‡à¹à¸¥à¸°à¸à¸¸à¸à¸­à¸‡", "expected": "à¸¨à¸±à¸¥à¸¢à¸à¸£à¸£à¸¡"}, # ç‡™å‚·
    {"symptom": "à¸£à¸–à¸¥à¹‰à¸¡ à¸¡à¸µà¹à¸œà¸¥à¸–à¸¥à¸­à¸à¸¥à¸¶à¸à¹à¸¥à¸°à¸¡à¸µà¹€à¸¨à¸©à¸«à¸´à¸™à¹ƒà¸™à¹à¸œà¸¥", "expected": "à¸¨à¸±à¸¥à¸¢à¸à¸£à¸£à¸¡"}, # è»Šç¦æ“¦å‚·
    {"symptom": "à¹€à¸›à¹‡à¸™à¸£à¸´à¸”à¸ªà¸µà¸”à¸§à¸‡à¸—à¸§à¸²à¸£ à¸™à¸±à¹ˆà¸‡à¹à¸¥à¹‰à¸§à¹€à¸ˆà¹‡à¸š", "expected": "à¸¨à¸±à¸¥à¸¢à¸à¸£à¸£à¸¡"}, # ç—”ç˜¡
    {"symptom": "à¹„à¸«à¸¥à¹ˆà¸«à¸¥à¸¸à¸” à¸¢à¸à¹à¸‚à¸™à¹„à¸¡à¹ˆà¸‚à¸¶à¹‰à¸™", "expected": "à¸¨à¸±à¸¥à¸¢à¸à¸£à¸£à¸¡"}, # è„«è‡¼
    {"symptom": "à¸›à¸§à¸”à¸—à¹‰à¸­à¸‡à¸™à¹‰à¸­à¸¢à¸”à¹‰à¸²à¸™à¸‚à¸§à¸²à¸ˆà¸±à¸” à¸ªà¸‡à¸ªà¸±à¸¢à¹„à¸ªà¹‰à¸•à¸´à¹ˆà¸‡à¸­à¸±à¸à¹€à¸ªà¸š", "expected": "à¸¨à¸±à¸¥à¸¢à¸à¸£à¸£à¸¡"}, # ç›²è…¸ç‚
    {"symptom": "à¹‚à¸”à¸™à¸ªà¸¸à¸™à¸±à¸‚à¸à¸±à¸”à¸—à¸µà¹ˆà¸‚à¸² à¹€à¸¥à¸·à¸­à¸”à¸­à¸­à¸", "expected": "à¸¨à¸±à¸¥à¸¢à¸à¸£à¸£à¸¡"}, # ç‹—å’¬
    {"symptom": "à¸¡à¸µà¸à¹‰à¸­à¸™à¸‹à¸µà¸ªà¸•à¹Œà¸—à¸µà¹ˆà¸«à¸¥à¸±à¸‡ à¹‚à¸•à¸‚à¸¶à¹‰à¸™à¹€à¸£à¸·à¹ˆà¸­à¸¢à¹†", "expected": "à¸¨à¸±à¸¥à¸¢à¸à¸£à¸£à¸¡"}, # ç²‰ç˜¤
    {"symptom": "à¹€à¸¥à¹‡à¸šà¸‚à¸š à¸™à¸´à¹‰à¸§à¸šà¸§à¸¡à¹€à¸›à¹‡à¸™à¸«à¸™à¸­à¸‡à¹à¸¥à¸°à¹€à¸ˆà¹‡à¸šà¸¡à¸²à¸", "expected": "à¸¨à¸±à¸¥à¸¢à¸à¸£à¸£à¸¡"}, # å‡ç”²

    # --- à¸«à¸¹ à¸„à¸­ à¸ˆà¸¡à¸¹à¸ (ENT) ---
    {"symptom": "à¹€à¸ˆà¹‡à¸šà¸„à¸­à¸¡à¸²à¸ à¸à¸¥à¸·à¸™à¸™à¹‰à¸³à¸¥à¸²à¸¢à¹€à¸«à¸¡à¸·à¸­à¸™à¸¡à¸µà¸¡à¸µà¸”à¸šà¸²à¸”", "expected": "à¸«à¸¹ à¸„à¸­ à¸ˆà¸¡à¸¹à¸"}, # å–‰åš¨ç—›
    {"symptom": "à¹€à¸›à¹‡à¸™à¸ à¸¹à¸¡à¸´à¹à¸à¹‰ à¸ˆà¸²à¸¡à¹à¸¥à¸°à¸™à¹‰à¸³à¸¡à¸¹à¸à¹„à¸«à¸¥à¹„à¸¡à¹ˆà¸«à¸¢à¸¸à¸”", "expected": "à¸«à¸¹ à¸„à¸­ à¸ˆà¸¡à¸¹à¸"}, # éæ•
    {"symptom": "à¸¡à¸µà¹€à¸ªà¸µà¸¢à¸‡à¸§à¸´à¹‰à¸‡à¹† à¹ƒà¸™à¸«à¸¹ à¹€à¸«à¸¡à¸·à¸­à¸™à¹à¸¡à¸¥à¸‡à¸šà¸´à¸™", "expected": "à¸«à¸¹ à¸„à¸­ à¸ˆà¸¡à¸¹à¸"}, # è€³é³´
    {"symptom": "à¹€à¸ªà¸µà¸¢à¸‡à¹à¸«à¸š à¸à¸¹à¸”à¹„à¸¡à¹ˆà¸¡à¸µà¹€à¸ªà¸µà¸¢à¸‡", "expected": "à¸«à¸¹ à¸„à¸­ à¸ˆà¸¡à¸¹à¸"}, # æ²™å•
    {"symptom": "à¸•à¹ˆà¸­à¸¡à¸—à¸­à¸™à¸‹à¸´à¸¥à¸­à¸±à¸à¹€à¸ªà¸š à¸šà¸§à¸¡à¹‚à¸•", "expected": "à¸«à¸¹ à¸„à¸­ à¸ˆà¸¡à¸¹à¸"}, # æ‰æ¡ƒè…º
    {"symptom": "à¹€à¸¥à¸·à¸­à¸”à¸à¸³à¹€à¸”à¸²à¹„à¸«à¸¥à¹„à¸¡à¹ˆà¸«à¸¢à¸¸à¸”", "expected": "à¸«à¸¹ à¸„à¸­ à¸ˆà¸¡à¸¹à¸"}, # æµé¼»è¡€
    {"symptom": "à¸šà¹‰à¸²à¸™à¸«à¸¡à¸¸à¸™ à¹€à¸§à¸µà¸¢à¸™à¸«à¸±à¸§à¹à¸¥à¸°à¸­à¸²à¹€à¸ˆà¸µà¸¢à¸™", "expected": "à¸«à¸¹ à¸„à¸­ à¸ˆà¸¡à¸¹à¸"}, # çœ©æšˆ
    {"symptom": "à¸«à¸¹à¸­à¸·à¹‰à¸­ à¹„à¸”à¹‰à¸¢à¸´à¸™à¹„à¸¡à¹ˆà¸Šà¸±à¸”", "expected": "à¸«à¸¹ à¸„à¸­ à¸ˆà¸¡à¸¹à¸"}, # è€³å¡
    {"symptom": "à¸à¹‰à¸²à¸‡à¸›à¸¥à¸²à¸•à¸´à¸”à¸„à¸­", "expected": "à¸«à¸¹ à¸„à¸­ à¸ˆà¸¡à¸¹à¸"}, # é­šåˆº
    {"symptom": "à¹€à¸›à¹‡à¸™à¸£à¹‰à¸­à¸™à¹ƒà¸™à¹ƒà¸™à¸›à¸²à¸ à¹€à¸ˆà¹‡à¸šà¸¡à¸²à¸à¸à¸´à¸™à¸‚à¹‰à¸²à¸§à¹„à¸¡à¹ˆà¹„à¸”à¹‰", "expected": "à¸«à¸¹ à¸„à¸­ à¸ˆà¸¡à¸¹à¸"}, # å£å…§ç‚

    # --- à¸œà¸´à¸§à¸«à¸™à¸±à¸‡ (Dermatology) ---
    {"symptom": "à¸ªà¸´à¸§à¸‚à¸¶à¹‰à¸™à¹€à¸•à¹‡à¸¡à¸«à¸™à¹‰à¸² à¸­à¸¢à¸²à¸à¸£à¸±à¸à¸©à¸²", "expected": "à¸œà¸´à¸§à¸«à¸™à¸±à¸‡"}, # é’æ˜¥ç—˜
    {"symptom": "à¸¡à¸µà¸œà¸·à¹ˆà¸™à¹à¸”à¸‡à¸‚à¸¶à¹‰à¸™à¸—à¸µà¹ˆà¸«à¸¥à¸±à¸‡ à¸„à¸±à¸™à¸¡à¸²à¸", "expected": "à¸œà¸´à¸§à¸«à¸™à¸±à¸‡"}, # ç´…ç–¹
    {"symptom": "à¹€à¸›à¹‡à¸™à¸•à¸²à¸›à¸¥à¸²à¸—à¸µà¹ˆà¸à¹ˆà¸²à¹€à¸—à¹‰à¸² à¹€à¸”à¸´à¸™à¹à¸¥à¹‰à¸§à¹€à¸ˆà¹‡à¸š", "expected": "à¸œà¸´à¸§à¸«à¸™à¸±à¸‡"}, # é›çœ¼
    {"symptom": "à¸£à¸±à¸‡à¹à¸„à¹€à¸¢à¸­à¸°à¸¡à¸²à¸ à¸„à¸±à¸™à¸«à¸™à¸±à¸‡à¸¨à¸µà¸£à¸©à¸°", "expected": "à¸œà¸´à¸§à¸«à¸™à¸±à¸‡"}, # é ­çš®å±‘
    {"symptom": "à¹€à¸¥à¹‡à¸šà¹€à¸›à¹‡à¸™à¹€à¸Šà¸·à¹‰à¸­à¸£à¸² à¸ªà¸µà¹€à¸¥à¹‡à¸šà¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸¥à¸°à¸«à¸™à¸²à¸•à¸±à¸§", "expected": "à¸œà¸´à¸§à¸«à¸™à¸±à¸‡"}, # ç°æŒ‡ç”²
    {"symptom": "à¸¥à¸¡à¸à¸´à¸©à¸‚à¸¶à¹‰à¸™à¸—à¸±à¹ˆà¸§à¸•à¸±à¸§ à¸„à¸±à¸™à¸„à¸°à¹€à¸¢à¸­", "expected": "à¸œà¸´à¸§à¸«à¸™à¸±à¸‡"}, # è•éº»ç–¹
    {"symptom": "à¸œà¸¡à¸£à¹ˆà¸§à¸‡à¹€à¸¢à¸­à¸°à¸¡à¸²à¸ à¸«à¸±à¸§à¸¥à¹‰à¸²à¸™à¹€à¸›à¹‡à¸™à¸«à¸¢à¹ˆà¸­à¸¡", "expected": "à¸œà¸´à¸§à¸«à¸™à¸±à¸‡"}, # æ‰é«®
    {"symptom": "à¸¡à¸µà¸«à¸¹à¸”à¹à¸‚à¹‡à¸‡à¹† à¸‚à¸¶à¹‰à¸™à¸—à¸µà¹ˆà¸à¹ˆà¸²à¹€à¸—à¹‰à¸²", "expected": "à¸œà¸´à¸§à¸«à¸™à¸±à¸‡"}, # ç—…æ¯’ç–£
    {"symptom": "à¸œà¸´à¸§à¹„à¸«à¸¡à¹‰à¹à¸”à¸” à¸¥à¸­à¸à¹à¸¥à¸°à¹à¸ªà¸šà¸¡à¸²à¸", "expected": "à¸œà¸´à¸§à¸«à¸™à¸±à¸‡"}, # æ›¬å‚·
    {"symptom": "à¹„à¸à¸•à¸²à¸¡à¸•à¸±à¸§à¹‚à¸•à¸‚à¸¶à¹‰à¸™à¹à¸¥à¸°à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸£à¸¹à¸›à¸£à¹ˆà¸²à¸‡", "expected": "à¸œà¸´à¸§à¸«à¸™à¸±à¸‡"}, # é»‘ç—£

    # --- à¸ˆà¸±à¸à¸©à¸¸ (Ophthalmology) ---
    {"symptom": "à¸•à¸²à¹à¸”à¸‡à¸à¹ˆà¸³ à¸¡à¸µà¸‚à¸µà¹‰à¸•à¸²à¹€à¸¢à¸­à¸°", "expected": "à¸ˆà¸±à¸à¸©à¸¸"}, # ç´…çœ¼
    {"symptom": "à¸•à¸²à¸¡à¸±à¸§ à¸¡à¸­à¸‡à¹€à¸«à¹‡à¸™à¸ à¸²à¸à¹€à¸›à¹‡à¸™à¹€à¸‡à¸²à¸”à¸³", "expected": "à¸ˆà¸±à¸à¸©à¸¸"}, # è¦–åŠ›æ¨¡ç³Š
    {"symptom": "à¸•à¸²à¹à¸«à¹‰à¸‡ à¹€à¸„à¸·à¸­à¸‡à¸•à¸²à¸¡à¸²à¸", "expected": "à¸ˆà¸±à¸à¸©à¸¸"}, # ä¹¾çœ¼
    {"symptom": "à¹€à¸›à¹‡à¸™à¸•à¸²à¸à¸¸à¹‰à¸‡à¸¢à¸´à¸‡ à¹€à¸›à¸¥à¸·à¸­à¸à¸•à¸²à¸šà¸§à¸¡", "expected": "à¸ˆà¸±à¸à¸©à¸¸"}, # é‡çœ¼
    {"symptom": "à¸ªà¸²à¸¢à¸•à¸²à¸ªà¸±à¹‰à¸™à¸‚à¸¶à¹‰à¸™ à¸¡à¸­à¸‡à¹„à¸à¸¥à¹„à¸¡à¹ˆà¸Šà¸±à¸”", "expected": "à¸ˆà¸±à¸à¸©à¸¸"}, # è¿‘è¦–
    {"symptom": "à¸„à¸­à¸™à¹à¸—à¸„à¹€à¸¥à¸™à¸ªà¹Œà¸•à¸´à¸”à¸•à¸² à¹€à¸­à¸²à¹„à¸¡à¹ˆà¸­à¸­à¸", "expected": "à¸ˆà¸±à¸à¸©à¸¸"}, # éš±å½¢çœ¼é¡
    {"symptom": "à¹€à¸«à¹‡à¸™à¸ˆà¸¸à¸”à¸”à¸³à¸¥à¸­à¸¢à¹„à¸›à¸¡à¸² (à¸§à¸¸à¹‰à¸™à¹ƒà¸™à¸•à¸²à¹€à¸ªà¸·à¹ˆà¸­à¸¡)", "expected": "à¸ˆà¸±à¸à¸©à¸¸"}, # é£›èšŠç—‡
    {"symptom": "à¸›à¸§à¸”à¸à¸£à¸°à¸šà¸­à¸à¸•à¸² à¸›à¸§à¸”à¸«à¸±à¸§ (à¸•à¸²à¸¥à¹‰à¸²)", "expected": "à¸ˆà¸±à¸à¸©à¸¸"}, # çœ¼å£“é«˜
    {"symptom": "à¹€à¸ªà¹‰à¸™à¹€à¸¥à¸·à¸­à¸”à¹ƒà¸™à¸•à¸²à¹à¸•à¸ à¸•à¸²à¸‚à¸²à¸§à¹à¸”à¸‡à¹€à¸›à¹‡à¸™à¸›à¸·à¹‰à¸™", "expected": "à¸ˆà¸±à¸à¸©à¸¸"}, # å‡ºè¡€
    {"symptom": "à¸¡à¸­à¸‡à¹€à¸«à¹‡à¸™à¹€à¸ªà¹‰à¸™à¸•à¸£à¸‡à¹€à¸›à¹‡à¸™à¹€à¸ªà¹‰à¸™à¹‚à¸„à¹‰à¸‡", "expected": "à¸ˆà¸±à¸à¸©à¸¸"} # è¦–åŠ›è®Šå½¢
]

correct_count = 0
results = []

print(f"ğŸš€ à¹€à¸£à¸´à¹ˆà¸¡à¸à¸²à¸£à¸—à¸”à¸ªà¸­à¸šà¸ à¸²à¸©à¸²à¹„à¸—à¸¢ ({len(test_cases)} cases)...\n")
print("â³ à¸à¸³à¸¥à¸±à¸‡à¸£à¸±à¸™ 5 à¸§à¸´à¸™à¸²à¸—à¸µ/à¸‚à¹‰à¸­ à¹€à¸à¸·à¹ˆà¸­à¸›à¹‰à¸­à¸‡à¸à¸±à¸™ Rate Limit (à¹ƒà¸Šà¹‰à¹€à¸§à¸¥à¸²à¸›à¸£à¸°à¸¡à¸²à¸“ 4 à¸™à¸²à¸—à¸µ)...")

# æ‚¨çš„å‰ç«¯ index.js ä½¿ç”¨çš„æ³°æ–‡é¸é …
valid_departments = "à¸­à¸²à¸¢à¸¸à¸£à¸à¸£à¸£à¸¡, à¸¨à¸±à¸¥à¸¢à¸à¸£à¸£à¸¡, à¸«à¸¹ à¸„à¸­ à¸ˆà¸¡à¸¹à¸, à¸œà¸´à¸§à¸«à¸™à¸±à¸‡, à¸ˆà¸±à¸à¸©à¸¸"

for i, case in enumerate(test_cases):
    prompt = f"""
    You are a professional Hospital Triage AI.
    
    Patient Symptom (Thai): "{case['symptom']}"
    
    Task:
    1. First, analyze the root cause and severity of the symptom (e.g., trauma, infection, or chronic issue).
    2. Then, select the ONE most suitable department from this list: [{valid_departments}].
    
    Output Requirements:
    - Output ONLY the department name from the list in Thai.
    - Do NOT output your analysis or any other text.
    """
    
    max_retries = 3
    for attempt in range(max_retries):
        try:
            start_time = time.time()
            response = model.generate_content(prompt)
            ai_reply = response.text.strip()
            
            is_correct = case['expected'] in ai_reply
            status = "âœ…" if is_correct else "âŒ"
            if is_correct:
                correct_count += 1
                
            print(f"[{i+1}/{len(test_cases)}] {status} | à¸­à¸²à¸à¸²à¸£: {case['symptom'][:15]}... -> {case['expected']} | AI: {ai_reply}")
            
            results.append({
                "ID": i+1,
                "Symptom": case['symptom'],
                "Expected": case['expected'],
                "AI_Reply": ai_reply,
                "Result": "Pass" if is_correct else "Fail"
            })
            break 
        except Exception as e:
            if "429" in str(e):
                print(f"âš ï¸ Rate limit hit (Case {i+1}), cooling down for 30s...")
                time.sleep(30)
            else:
                print(f"âš ï¸ Error at case {i+1}: {e}")
                break

    time.sleep(5) 

accuracy = (correct_count / len(test_cases)) * 100
print(f"\n{'='*30}")
print(f"ğŸ† à¸à¸²à¸£à¸—à¸”à¸ªà¸­à¸šà¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸´à¹‰à¸™! (Test Finished)")
print(f"Accuracy: {accuracy:.2f}%")
print(f"{'='*30}")

try:
    df = pd.DataFrame(results)
    df.to_csv("ai_test_result_th_50.csv", index=False, encoding='utf-8-sig')
    print("ğŸ“„ Saved to ai_test_result_th_50.csv")
except:
    pass